---
title: "Customer Segmentation and Life Time Value for Flash Deal Site "
author: "Steffen Hartleib"
date: "April 19, 2016"
output: html_document
---

### The Data Set

Purchase data from 2010 to 2015

Fields:  
1. Customer Email  
2. Purchase Date  
3. Purchase Amount  


### Questions
1. Which customer segments are driving revenue?  
2. What is the  average life time value of a customer?

***

### Let's look at year over year trends 
#####

```{r, echo = FALSE, eval = TRUE, message=FALSE ,warning = FALSE}

# load packages
library(dplyr)
library(reshape2)
library(ggplot2)
library(knitr)
options(scipen=10000)

# read data:
setwd("~/Google Drive/Analysis/popmarket_clv_2015")
data = read.csv("data/PopMarketOrders.txt", header = FALSE, stringsAsFactors = FALSE)
# select revlevant columns
data_1 = data[,c('V1','V6','V9')]
# add column names
colnames(data_1) = c('email','amount','purchase_date')
# fix date
data_1$purchase_date = as.Date(data_1$purchase_date, '%Y-%m-%d')
# add purchase year colum
data_1$purchase_year = as.numeric(format(data_1$purchase_date,'%Y'))
# remove 2016
data_1 = data_1[which(data_1$purchase_year < 2016),]
# add recency column
data_1$days_since = as.numeric(difftime(time1 = '2016-01-01',
                                        time2 = data_1$purchase_date,
                                        units ='days'))
```


```{r, echo = FALSE, eval= TRUE,  message=FALSE ,warning = FALSE}
# summary statistics
yearly_rev = select(data_1, purchase_year, amount, email)%>%
                group_by(purchase_year)%>%
                summarize(rev = round(sum(amount),0),
                          cust = round(length(unique(email)),0),
                          pur = n(),
                          avg_price = round(mean(amount),0),
                          avg_rev_cust = round(sum(amount)/length(unique(email)),0),
                          avg_no_purch_cust = round(n()/length(unique(email)),2))

ggplot(yearly_rev, aes(purchase_year, rev)) + geom_bar(stat= "identity") + 
        ggtitle("Revenue is declining\n") + ylab("$ Revenue") + xlab("Year")

ggplot(yearly_rev, aes(purchase_year, cust)) + geom_bar(stat= "identity") + 
        ggtitle("Number of active customers is declining\n") + ylab("No. of active customers") + xlab("Year")

ggplot(yearly_rev, aes(purchase_year, avg_price)) + geom_bar(stat= "identity") + ggtitle("Average purchase price is up slightly\n ") + ylab("Avg. Purchase Price") +  xlab("Year")

ggplot(yearly_rev, aes(purchase_year, avg_rev_cust)) + geom_bar(stat= "identity") + ggtitle("Avgerage revenue per customer is increasing \n") + ylab("Avg. Rev. per customer") + xlab('Year')

ggplot(yearly_rev, aes(purchase_year, avg_no_purch_cust)) + geom_bar(stat= "identity") + ggtitle('Avgerage numnber of purchases per customer is increasing\n') + ylab("Avg. no. purchases per customer")
```


=> Fewer customers are spending slightly more on average, but not enough to reverse the decline of revenue. 

***

## Segmenting customers  
For each customer we'll caclulate the following variables:  


```{r, echo = FALSE , eval = TRUE, message=FALSE, warning = FALSE}
# group by email for LTD values
customers_2015 = select(data_1, email, amount, purchase_year,days_since)%>%
                 group_by(email)%>%
                 filter(amount > 0)%>%
                 summarize(avg_amount = mean(amount),
                           tl_rev = round(sum(amount),0),
                           recency = min(days_since),
                           first_purchase = max(days_since),
                           frequency = n())
#dim(customers_2015)

# get 2015 revenue by customer
customer_rev_2015 = select(data_1,email,amount,days_since)%>%
                    filter(days_since <= 365)%>%
                    group_by(email)%>%
                    summarize(Rev_2015 = round(sum(amount),0))

customers_2015 = merge(customers_2015,customer_rev_2015, all.x = TRUE, by = 'email')
customers_2015$Rev_2015[which(is.na(customers_2015$Rev_2015))] = 0

means = select(customers_2015, avg_amount, tl_rev, recency, 
              first_purchase,frequency,Rev_2015)%>%
              summarize_each(funs(mean))%>%
              summarize_each(funs(round))
      
mins = select(customers_2015, avg_amount, tl_rev, recency, 
              first_purchase,frequency,Rev_2015)%>%
              summarize_each(funs(min))%>%
              summarize_each(funs(round))

max = select(customers_2015, avg_amount, tl_rev, recency, 
              first_purchase,frequency,Rev_2015)%>%
              summarize_each(funs(max))%>%
              summarize_each(funs(round))


med = select(customers_2015, avg_amount, tl_rev, recency, 
              first_purchase,frequency,Rev_2015)%>%
              summarize_each(funs(median))%>%
              summarize_each(funs(round))


summary = rbind(prettyNum(round(mins),big.mark=","),
                prettyNum(round(means),big.mark=","),
                prettyNum(round(med),big.mark= ","),
                prettyNum(round(max),big.mark = ","))

row.names(summary) = c('Minimum','Average','Median','Max')
colnames(summary) = c("Avg. Purchase","LTD Revenue","Recency","Days since first purch.", "No of Purchases","Revenue 2015")
kable(summary)

```


***

### Let's segment customers on recency and LTD revenue as follows:
 
Segment        | Recency                | LTD Revenue  
-------------  | ---------------------  | -------------  
 Active New    | 1st purchase last year | 
 Active Low    | purchase last year     | < $100
 Active Med    | purchase last year     | >= $100 & < $1000
 Activ High    | purchase last year     | > $1000
 Inactive Low  | no purchase last year  | < $100
 Inactive Med  | no purchase last year  | >= $100 & < $1000
 Inactive High | no purchase last year  | > $1000


***
   
### Summary of the segments:  

```{r, echo = FALSE, Eval = TRUE, message=FALSE ,warning = FALSE}

# 2015 PopMarket Segments

customers_2015$segment = 'NA'
customers_2015$segment[which(customers_2015$recency > 365*1)] = 'inactive'
customers_2015$segment[which(customers_2015$recency <= 365*1)] = 'active'
customers_2015$segment[which(customers_2015$segment == 'active' & customers_2015$first_purchase <= 365)] = 'active new'
customers_2015$segment[which(customers_2015$segment == 'active' & customers_2015$tl_rev < 100) ] = 'active low'
customers_2015$segment[which(customers_2015$segment == 'active' & customers_2015$tl_rev >= 100) ] = 'active med'  
customers_2015$segment[which(customers_2015$segment == 'active med' & customers_2015$tl_rev >= 1000) ] = 'active high'

customers_2015$segment[which(customers_2015$segment == 'inactive' & customers_2015$tl_rev < 100)] = 'inactive low'
customers_2015$segment[which(customers_2015$segment == 'inactive' & customers_2015$tl_rev >= 100)] = 'inactive med'
customers_2015$segment[which(customers_2015$segment == 'inactive med' & customers_2015$tl_rev >= 1000)] = 'inactive high'
customers_2015$segment  = factor(x = customers_2015$segment, levels = c('active new', 'active high','active med', 'active low',
                                                                        'inactive high', 'inactive med', 'inactive low'))

segments_2015 = select(customers_2015, segment, tl_rev, Rev_2015 )%>%
                        group_by(segment)%>%
                        summarize(Customers = n(),
                        PercOfTlCustomers = round(Customers/length(customers_2015$segment),2),
                        RevTD = sum(tl_rev),
                        Rev2015  = sum(Rev_2015),
                        PercOfTlRev2015 = round(sum(Rev_2015)/sum(customers_2015$Rev_2015),2))

                        
                        
#print(segments_2015[,1:3])

```
```{r kable, eval=TRUE, echo=FALSE}
library(knitr)
kable(segments_2015, col.names = c('Segments','Customers','Perc of Cust','Rev. LTD','Rev 2015','Perc Tl Rev 2015'))
```

```{r, echo = FALSE,eval=TRUE, message=FALSE ,warning = FALSE}

customers_2014 = select(data_1, email, amount, purchase_year,days_since)%>%
        filter(days_since  > 365)%>%  # remove all purchases made mode in the last year 
        group_by(email)%>%
        summarize(avg_amount = mean(amount),
                  tl_rev = sum(amount),
                  recency = min(days_since),
                  first_purchase = max(days_since),
                  frequency = n())

customers_rev_2014 = select(data_1,email,amount,days_since)%>%
                    filter(days_since > 365 & days_since <= 356*2)%>%
                    group_by(email)%>%
                    summarize(Rev_2014 = sum(amount))

customers_2014 = merge(customers_2014,customers_rev_2014, all.x = TRUE, by = 'email')

customers_2014$Rev_2014[which(is.na(customers_2014$Rev_2014))] = 0


# segment 2014 data
customers_2014$segment = 'NA'
customers_2014$segment[which(customers_2014$recency > 365*2)] = 'inactive'
customers_2014$segment[which(customers_2014$recency <= 365*2)] = 'active'

customers_2014$segment[which(customers_2014$segment == 'active' & customers_2014$first_purchase <= 365*2)] = 'active new'
customers_2014$segment[which(customers_2014$segment == 'active' & customers_2014$tl_rev < 100) ] = 'active low'
customers_2014$segment[which(customers_2014$segment == 'active' & customers_2014$tl_rev >= 100) ] = 'active med'  ####
customers_2014$segment[which(customers_2014$segment == 'active med' & customers_2014$tl_rev >= 1000) ] = 'active high'

customers_2014$segment[which(customers_2014$segment == 'inactive' & customers_2014$tl_rev < 100)] = 'inactive low'
customers_2014$segment[which(customers_2014$segment == 'inactive' & customers_2014$tl_rev >= 100)] = 'inactive med'
customers_2014$segment[which(customers_2014$segment == 'inactive med' & customers_2014$tl_rev >= 1000)] = 'inactive high'

customers_2014$segment  = factor(x = customers_2014$segment, levels = c('active new', 'active high','active med', 'active low',
                                                                        'inactive high', 'inactive med', 'inactive low'))

segments_2014 = select(customers_2014, segment, tl_rev,Rev_2014)%>%
        group_by(segment)%>%
        summarize(Customers = n(),
                  PercOfTotal = round(Customers/length(customers_2014$segment),2),
                  Rev = sum(tl_rev),
                  Rev_2014 = sum(Rev_2014),
                  PercOfTlRev2014 = round(Rev_2014/sum(customers_2014$Rev_2014),2)
                  )

# 2013 Customer Segments i.e. excluding all purchases made up until a year ago (then same analysis as above)

customers_2013 = select(data_1, email, amount, purchase_year,days_since)%>%
        filter(days_since  > 365*2)%>%  # remove all purchases made mode in the last 2 years
        group_by(email)%>%
        summarize(avg_amount = mean(amount),
                  tl_rev = sum(amount),
                  recency = min(days_since),
                  first_purchase = max(days_since),
                  frequency = n())

customer_rev_2013 = select(data_1,email,amount,days_since)%>%
                    filter(days_since > 365*2 & days_since <= 356*3)%>%
                    group_by(email)%>%
                    summarize(Rev_2013 = sum(amount))

customers_2013 = merge(customers_2013,customer_rev_2013, all.x = TRUE, by = 'email')
customers_2013$Rev_2013[which(is.na(customers_2013$Rev_2013))] = 0

# segment 2013 data
customers_2013$segment = 'NA'
customers_2013$segment[which(customers_2013$recency > 365*3)] = 'inactive'
customers_2013$segment[which(customers_2013$recency <= 365*3)] = 'active'
#table(customers_2013$segment)

customers_2013$segment[which(customers_2013$segment == 'active' & customers_2013$first_purchase < 365*3)] = 'active new'
customers_2013$segment[which(customers_2013$segment == 'active' & customers_2013$tl_rev < 100) ] = 'active low'
customers_2013$segment[which(customers_2013$segment == 'active' & customers_2013$tl_rev >= 100) ] = 'active med'  ####
customers_2013$segment[which(customers_2013$segment == 'active med' & customers_2013$tl_rev >= 1000) ] = 'active high'

customers_2013$segment[which(customers_2013$segment == 'inactive' & customers_2013$tl_rev < 100)] = 'inactive low'
customers_2013$segment[which(customers_2013$segment == 'inactive' & customers_2013$tl_rev >= 100)] = 'inactive med'
customers_2013$segment[which(customers_2013$segment == 'inactive med' & customers_2013$tl_rev >= 1000)] = 'inactive high'

customers_2013$segment  = factor(x = customers_2013$segment, levels = c('active new', 'active high','active med', 'active low',
                                                                        'inactive high', 'inactive med', 'inactive low'))

segments_2013 = select(customers_2013, segment, tl_rev,Rev_2013)%>%
        group_by(segment)%>%
        summarize(Customers = n(),
                  PercOfTlCust = round(Customers/length(customers_2013$segment),2),
                  Rev = sum(tl_rev),
                  Rev_2013 = sum(Rev_2013),
                  PercOfTlRev2013 = round(Rev_2013/sum(customers_2013$Rev_2013),2)
                  )
```

***

### Here is how the customer segments changed over time:

```{r,echo=FALSE, eval=TRUE, message=FALSE,warning=FALSE}
segments_year = cbind(segments_2013,segments_2014,segments_2015)
segments_year = cbind(segments_2013,segments_2014[,2:6],segments_2015[,2:6])

```

```{r,echo=FALSE, eval=TRUE,message=FALSE,warning=FALSE}
# make table to compare no of customers per segments per year
segments_customers = segments_year[,c(1,2,7,12)]
colnames(segments_customers) = c('Segments','2013','2014','2015')
#segments_customers 
segments_customers_long = melt(segments_customers, value.name  = 'Customers')
colnames(segments_customers_long) <- c('Segment','Year','No_of_Customers')

# plot no of customers per segment per year
plot_seg = ggplot(segments_customers_long,aes(Year, No_of_Customers))
plot_seg + geom_point() + facet_grid(.~ Segment) + ggtitle("Number of customers per segmnet\n over the last three years\n") + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ylab("Number of customers\n")
```

=> New Active customers declined by over 50% 2 years in a row
=> Active Medium customer are declining as well, but at a slower rate  
=> Active High customer have slightly increased


### Here is how revenue per segment stacks up, over time:
```{r,echo=FALSE, eval=TRUE,message=FALSE,warning=FALSE}
# make table to compare yearly REVENUE per segments per year
segments_rev = segments_year[,c(1,5,10,15)]
colnames(segments_rev) = c('Segments','2013','2014','2015')
segments_rev_long = melt(segments_rev, value.name  = 'Customers')
colnames(segments_rev_long) <- c('Segment','Year','Revenue')


#### => As expected yearly revenue per segment declined at about the same rate as the nunber of customers in each segment.

```{r,echo=FALSE, eval=TRUE,message=FALSE,warning=FALSE}
plot_seg_rev = ggplot(segments_rev_long, aes(Year, Revenue,fill = Segment)) +  geom_bar(stat = 'identity') + ggtitle('Revenue by Customer Segment\n')
plot_seg_rev + ylab("Revenue\n") + xlab("Year\n")
```


```{r,echo=FALSE, eval=TRUE,message=FALSE,warning=FALSE}
# make table to compare perc of yearly revenue by segment
segments_rev_perc = segments_year[c(1,6,11,16)]
colnames(segments_rev_perc) = c('Segment','2013','2014','2015')
seg_rev_perc_long = melt(segments_rev_perc,value.name = 'Perc_of_Yearly_Rev')
colnames(seg_rev_perc_long) <- c('Segment','Year','Rev_Perc')
```
The decline in revenue is driven by the decline in active new customers.
Revenue from repeat customers is slightly increasing, but not enough to reverse the downward trend 

```{r,echo=FALSE, eval=TRUE,message=FALSE,warning=FALSE}
# plot perc of yearly revenue by segment  - bar chart
#plot_seg_rev_perc = ggplot(seg_rev_perc_long, aes(Year, Rev_Perc,fill = Segment)) +  geom_bar(stat = 'identity') 
#plot_seg_rev_perc + ggtitle('Revenue per segment\n as perc. of total\n') +
#ylab('Revenue as perc. of total')
```
 

=> We have a customer acquistion and a customer retention problem  

=> Let's calculate Customer Life Time value, so that we know how much we can spend on customer acquistion, while maintaining a positive return on investment (ROI).

***

## Customer Life Time Value


```{r,echo=FALSE, eval=TRUE,message=FALSE,warning=FALSE}

#join with table of all customers in each segment for each year
#actual = merge(customers_2015,rev_2015, all.x = TRUE, by = 'email')
#actual = merge(actual,rev_2014, all.x = TRUE, by = 'email')
#actual = merge(actual,rev_2013, all.x = TRUE, by = 'email')
#actual$rev_2015[is.na(actual$rev_2015)] = 0
#actual$rev_2014[is.na(actual$rev_2014)] = 0
#actual$rev_2013[is.na(actual$rev_2013)] = 0
#summary(actual)
#head(actual)

```

***

### Transition Matrix 
Shows the probabilities of customers changing segments between 2014 and 2015

```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
new_data = merge(x = customers_2014, y = customers_2015, by = 'email', all.x = TRUE)

transition = table(new_data$segment.x, new_data$segment.y)
transition =  round(transition / rowSums(transition),2)
kable(transition)
```
***

### Let's take a closer look at what happens to 'New Active' customers (first row of transition matrix)

```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
trans = data.frame(transition)
new_active_trans = trans[which(trans$Var1 == 'active new'),]
new_active_trans = mutate(new_active_trans[-1,],perc = Freq/sum(Freq))
ggplot(new_active_trans, aes(Var2, perc)) + geom_bar(stat ='identity') + 
        ggtitle('New active customers in 2014\n moved to the following segments in
                2015\n') + ylab('Percentage of total "New Active" customers\n') +
        xlab('Segments')

```

=> 80% of New Active customers dont' come back the next year

***

### Forecast the number of customers in each segment over the next 5 years

We assume that customers will transition from segment to segment in the same proportions as they did from 2014 to 2015. We can therefore multiply each period's segments by the transition matrix to forecast the number of customer per segment in the next period.


```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# initialize a matrix with the number of customers in each segment today and after 10 periods

segments = matrix(nrow = 7, ncol = 6)
segments[,1] = table(customers_2015$segment)
colnames(segments) = 2015:2020
rownames(segments) = levels(customers_2015$segment)
#dim(segments)
#segments[,1]


# compute for every period

for (i in 2:6) {
        segments[,i] =  segments[,i-1] %*% transition
}

segments[,2] = segments[,1] %*% transition
#segments[,1]%*% transition
round(segments)
```

***

### Forecast revenue per segment for the next 5 years
(assuming that on average revenue per segment stays the same over time)

```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}

# average rev per customer in each segment in 2015

rev_2015_segment = select(customers_2015, Rev_2015, segment)%>%
                   group_by(segment)%>%
                   summarize(avg_rev = round(mean(Rev_2015),0))

#print(rev_2015_segment)

yearly_revenue = rev_2015_segment$avg_rev
revenue_per_segment = round(yearly_revenue * segments,0)
#revenue_per_segment
```

***


```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#Compute yearly revenue

yearly_revenue = colSums(revenue_per_segment)
#print(round(yearly_revenue))
yearly_rev_seg_long = melt(revenue_per_segment)
colnames(yearly_rev_seg_long) = c('Segment','Year','Revenue')
#yearly_rev_seg_long
ggplot(yearly_rev_seg_long, aes(Year, Revenue, fill=Segment)) + geom_bar(stat = 'identity') + ggtitle('Revenue Forecast by Segment\n')
```

***

```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#Compute cumulative revenue
# yearly_revenue
cumulative_revenue = cumsum(yearly_revenue)
#print(round(cumulative_revenue))
cume_rev = data.frame(cumulative_revenue)
cume_rev$Year = row.names(cume_rev)
row.names(cume_rev) = NULL
ggplot(cume_rev, aes(Year, cumulative_revenue)) + geom_bar(stat = 'identity') + ggtitle('Cumulative Revenue Projected\n')

```

***

```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#create discount factor
discount_rate = .1
discount = 1 / (1 + discount_rate) ^ ((1:7)-1)
#discount
```

```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# compute yearly discounted revenue

#yearly_revenue
disc_yearly_revenue = discount * yearly_revenue
#print(round(disc_yearly_revenue))

```

```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# compute discounted cumulative revenue

disc_cumulative_revenue = cumsum(disc_yearly_revenue)
disc_cume_rev = data.frame(disc_cumulative_revenue)
disc_cume_rev$Year = row.names(disc_cume_rev)
row.names(disc_cume_rev) = NULL
colnames(disc_cume_rev) = c("Cume_Rev", "Year")
ggplot(disc_cume_rev, aes(Year, Cume_Rev)) + geom_bar(stat = 'identity') + ggtitle('Present Value of Cumulative Revenue\n Discounted at 10%\n') + ylab("Cumulative Revenue")
```

Total present value of the data base is:
```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# what is the data base worth?
cust_value = print(disc_cumulative_revenue[6] - disc_cumulative_revenue[1])
cust_value = prettyNum(cust_value, big.mark = ",")

```
### Customer Life  Time Value
```{r,echo = FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# Customer Life Time value
LTV = prettyNum((disc_cumulative_revenue[6] - disc_cumulative_revenue[1])/dim(customers_2015)[1],big.mark = ",", digits = 4)

value_table = data.frame(LTV, cust_value)
colnames(value_table) = c("Customer Life Time Value", "Total Present Value of Data Base")
kable(value_table)
```




